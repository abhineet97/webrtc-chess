!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";function d(){return window.location.hash&&0!==window.location.hash.length?"b":"w"}function e(){a("./lib/chessboard/chessboard.js");var b,c,e,f,g,h,i,j=a("chess.js").Chess,k=a("peerjs"),l=new k({key:"618b8av1yey4lsor"}),m={},n={},o=!1;e=function(a,d){if(!s())return void b.unselectSquare(a);if(0===d.length)return void(c.moves({square:a}).length>0&&b.selectSquare(a));var e=d[0];if(a===e)return void b.unselectSquare(a);var f=c.get(a),g=c.get(e);if(f&&f.color===g.color)return void b.unselectSquare(a);var i=c.moves({square:e,verbose:!0}),j=i.filter(function(b){return b.to===a}).length>0;return j?void("p"!==g.type||"1"!==a[1]&&"8"!==a[1]?h(e,a):b.askPromotion(g.color,function(b){h(e,a,b)})):void t("Invalid move. Try Again.")},h=function(a,d,e){c.move({from:a,to:d,promotion:e}),b.setPosition(c.fen()),p(),b.unselectAllSquares()};var p=function(){n.dataConnection.send(c.fen()),i()};i=function(){c.game_over()?(c.in_draw()&&t("Game Over. It's a DRAW."),t("Game Over. You have "+(c.turn()===m.color?"LOST":"WON"))):t(c.in_check()?(c.turn()===m.color?"You are":"Opponent is")+" in CHECK.":(c.turn()===m.color?"Your":"Opponent's")+" turn.")};var q=document.querySelector("dialog"),r=function(a){q.innerHTML=a,q.showModal()},s=function(){return c.game_over()?(i(),!1):c.turn()!==m.color?(t("Not your turn"),!1):o?!0:(t(l.disconnected?"Connection to your opponent has been lost.":"Please wait while we connect to your opponent..."),!1)},t=function(a){document.getElementById("msg").innerHTML=a};f=function(a){console.log("Recieved",a),c.load(a),b.setPosition(c.fen()),i()},g=function(a){"w"===m.color?(q.close(),t("Connected to opponent, play your turn.")):t("Connected to opponent, waiting for him/her to play..."),o=!0,n.dataConnection=a},l.on("open",function(a){if(t("Waiting for opponent..."),0!==window.location.hash.length){m={id:a,color:"b"},n={id:window.location.hash.split("#").pop(),color:"w"};var b=l.connect(n.id);t("Connecting to opponent..."),b.on("open",function(){g(b)}),b.on("data",f)}else m={color:"w",id:a},n={color:"b"},r('Share this URL to begin<br><input onclick="this.select();" value="'+window.location.href+"#"+m.id+'">')}),l.on("connection",function(a){a.on("open",function(){g(a)}),a.on("data",f)}),c=j(),b=new ChessBoard("board",{onSquareClick:e,orientation:d()})}document.addEventListener("DOMContentLoaded",e)},{"./lib/chessboard/chessboard.js":2,"chess.js":3,peerjs:8}],2:[function(a,b,c){"use strict";window.ChessBoard=function(a,b){function c(a,b){return String.fromCharCode(97+b)+a}function d(){var b=document.getElementById(a);b.classList.add("chessboard"),"b"===t.orientation&&b.classList.add("flipped"),z.element=b;for(var d=8;d>=1;d--){var e=document.createElement("div");z[d]={element:e};for(var f=0;8>f;f++){var g=document.createElement("div");(d+f)%2===0?g.className="white square":g.className="black square",g.setAttribute("data-square",c(d,f)),t.onSquareClick&&g.addEventListener("click",n),z[d][f]={element:g,piece:null},e.appendChild(g)}b.appendChild(e)}}function e(a){var b=document.createElement("div");return b.className="square "+a,b.setAttribute("data-piece",a),A.pieces.push({piece:a,element:b}),b}function f(a){var b=document.createElement("div");b.className="pieces",b.appendChild(e(a+"Q")),b.appendChild(e(a+"R")),b.appendChild(e(a+"N")),b.appendChild(e(a+"B")),"w"===a?A.whitePiecesWrapper=b:A.blackPiecesWrapper=b}function g(){f("w"),f("b");var a=document.createElement("button"),b=document.createTextNode("Promote");a.appendChild(b),A.promoteButton=a;var c=document.createElement("div");c.appendChild(a),A.promoteButtonWrapper=c;var d=document.createElement("div");d.className="promotion-wrapper",d.appendChild(A.whitePiecesWrapper),d.appendChild(A.blackPiecesWrapper),d.appendChild(c),A.wrapper=d;var e=document.createElement("div");e.className="promotion-overlay",A.overlay=e,e.appendChild(d),z.element.appendChild(e);for(var g=0,j=A.pieces.length;j>g;g++)A.pieces[g].element.addEventListener("click",h);a.addEventListener("click",i)}function h(a){var b=a.target;if(b!==A.selectedElement){if(null===A.selectedElement)return A.selectedElement=b,b.classList.add("selected"),void(A.promoteButton.disabled=!1);A.selectedElement.classList.remove("selected"),A.selectedElement=b,b.classList.add("selected")}}function i(){var a=A.selectedElement.getAttribute("data-piece"),b=String.fromCharCode(a.charCodeAt(1)+32);A.overlay.style.display="none",A.callback&&A.callback(b)}function j(){var a=getComputedStyle(z.element.parentNode),b=parseInt(a.width)-parseInt(a.paddingLeft)-parseInt(a.paddingRight);w=Math.floor((b-2*v)/8),w=Math.min(w,t.maxSquareSize),w=Math.max(w,t.minSquareSize)}function k(){j();var a=w+"px",b=8*w+"px",c=6*w+"px";z.element.style.width=8*w+x+"px";for(var d=8;d>=1;d--){z[d].element.style.width=b,z[d].element.style.height=a;for(var e=0;8>e;e++)z[d][e].element.style.width=a,z[d][e].element.style.height=a,z[d][e].element.style.backgroundSize=c,z[d][e].element.style.backgroundPosition=l(z[d][e].piece)}A.wrapper.style.width=4*w+"px",A.wrapper.style.height=2*w+"px",A.wrapper.style.marginTop=3*w+"px",A.whitePiecesWrapper.style.height=a,A.blackPiecesWrapper.style.height=a;for(var f=0,g=A.pieces.length;g>f;f++){var h=A.pieces[f].piece,i=A.pieces[f].element;i.style.width=a,i.style.height=a,i.style.backgroundSize=c,i.style.backgroundPosition=l(h)}A.promoteButtonWrapper.style.height=a,A.promoteButtonWrapper.style.lineHeight=a,A.promoteButton.style.fontSize=w/2.5+"px"}function l(a){switch(a){case"wP":return"0 0";case"wB":return-1*w+"px 0";case"wN":return-2*w+"px 0";case"wR":return-3*w+"px 0";case"wQ":return-4*w+"px 0";case"wK":return-5*w+"px 0";case"bP":return"0 "+-1*w+"px";case"bB":return-1*w+"px "+-1*w+"px";case"bN":return-2*w+"px "+-1*w+"px";case"bR":return-3*w+"px "+-1*w+"px";case"bQ":return-4*w+"px "+-1*w+"px";case"bK":return-5*w+"px "+-1*w+"px"}}function m(a){var b=a[0].charCodeAt(0)-97,c=+a[1];return z[c][b]}function n(a){var b=a.target.getAttribute("data-square");t.onSquareClick(b,y)}function o(a){var b=m(a),c=b.piece;null!==c&&b.element.classList.remove(c),b.piece=null}function p(a,b){for(var c="";c.length<b;)c+=a;return c}function q(a,b){var c=m(a),d=c.piece;null!==d&&c.element.classList.remove(d),c.element.classList.add(b),c.element.style.backgroundPosition=l(b),c.piece=b}function r(a){var b=a.charCodeAt(0);return b>=97?"b"+String.fromCharCode(b-32):"w"+a}var s=this,t={fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",resize:!0,orientation:"w",minSquareSize:20,maxSquareSize:64};for(var u in b)t[u]=b[u];var v,w,x,y=[],z={},A={pieces:[],selectedElement:null};this.selectSquare=function(a){if(!(y.indexOf(a)>-1)){var b=m(a);b.element.classList.add("selected"),y.push(a)}},this.unselectSquare=function(a){var b=y.indexOf(a);if(-1!==b){var c=m(a);c.element.classList.remove("selected"),y.splice(b,1)}},this.unselectAllSquares=function(){for(var a=0,b=y.length;b>a;a++){var c=m(y[a]);c.element.classList.remove("selected")}y=[]},this.setPosition=function(a){for(var b=a.split(" "),d=b[0].split("/"),e=0;8>e;e++){d[e]=d[e].replace(/\d/g,function(a){return p(".",+a)});for(var f=0;8>f;f++){var g=c(8-e,f);"."===d[e][f]?o(g):q(g,r(d[e][f]))}}},this.askPromotion=function(a,b){A.callback=b,A.whitePiecesWrapper.style.display="w"===a?"block":"none",A.blackPiecesWrapper.style.display="b"===a?"block":"none",A.promoteButton.disabled=!0,null!==A.selectedElement&&A.selectedElement.classList.remove("selected"),A.selectedElement=null,A.overlay.style.display="block"},d(),g(),setTimeout(function(){var a=getComputedStyle(z.element);v=parseInt(a.borderTopWidth),x="border-box"===a.boxSizing?2*v:0,k(),s.setPosition(t.fen)}),t.resize&&window.addEventListener("resize",k)}},{}],3:[function(a,b,c){"use strict";var d=function(a){function b(){ga=new Array(128),ha={w:L,b:L},ia=K,ja={w:0,b:0},ka=L,la=0,ma=1,na=[],oa={},h(f())}function c(){d(T)}function d(a){var c=a.split(/\s+/),d=c[0],g=0;if(!e(a).valid)return!1;b();for(var i=0;i<d.length;i++){var k=d.charAt(i);if("/"===k)g+=8;else if(E(k))g+=parseInt(k,10);else{var l="a">k?K:J;j({type:k.toLowerCase(),color:l},C(g)),g++}}return ia=c[1],c[2].indexOf("K")>-1&&(ja.w|=_.KSIDE_CASTLE),c[2].indexOf("Q")>-1&&(ja.w|=_.QSIDE_CASTLE),c[2].indexOf("k")>-1&&(ja.b|=_.KSIDE_CASTLE),c[2].indexOf("q")>-1&&(ja.b|=_.QSIDE_CASTLE),ka="-"===c[3]?L:ea[c[3]],la=parseInt(c[4],10),ma=parseInt(c[5],10),h(f()),!0}function e(a){var b={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large].",11:"Illegal en-passant square"},c=a.split(/\s+/);if(6!==c.length)return{valid:!1,error_number:1,error:b[1]};if(isNaN(c[5])||parseInt(c[5],10)<=0)return{valid:!1,error_number:2,error:b[2]};if(isNaN(c[4])||parseInt(c[4],10)<0)return{valid:!1,error_number:3,error:b[3]};if(!/^(-|[abcdefgh][36])$/.test(c[3]))return{valid:!1,error_number:4,error:b[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(c[2]))return{valid:!1,error_number:5,error:b[5]};if(!/^(w|b)$/.test(c[1]))return{valid:!1,error_number:6,error:b[6]};var d=c[0].split("/");if(8!==d.length)return{valid:!1,error_number:7,error:b[7]};for(var e=0;e<d.length;e++){for(var f=0,g=!1,h=0;h<d[e].length;h++)if(isNaN(d[e][h])){if(!/^[prnbqkPRNBQK]$/.test(d[e][h]))return{valid:!1,error_number:9,error:b[9]};f+=1,g=!1}else{if(g)return{valid:!1,error_number:8,error:b[8]};f+=parseInt(d[e][h],10),g=!0}if(8!==f)return{valid:!1,error_number:10,error:b[10]}}return"3"==c[3][1]&&"w"==c[1]||"6"==c[3][1]&&"b"==c[1]?{valid:!1,error_number:11,error:b[11]}:{valid:!0,error_number:0,error:b[0]}}function f(){for(var a=0,b="",c=ea.a8;c<=ea.h1;c++){if(null==ga[c])a++;else{a>0&&(b+=a,a=0);var d=ga[c].color,e=ga[c].type;b+=d===K?e.toUpperCase():e.toLowerCase()}c+1&136&&(a>0&&(b+=a),c!==ea.h1&&(b+="/"),a=0,c+=8)}var f="";ja[K]&_.KSIDE_CASTLE&&(f+="K"),ja[K]&_.QSIDE_CASTLE&&(f+="Q"),ja[J]&_.KSIDE_CASTLE&&(f+="k"),ja[J]&_.QSIDE_CASTLE&&(f+="q"),f=f||"-";var g=ka===L?"-":C(ka);return[b,ia,f,g,la,ma].join(" ")}function g(a){for(var b=0;b<a.length;b+=2)"string"==typeof a[b]&&"string"==typeof a[b+1]&&(oa[a[b]]=a[b+1]);return oa}function h(a){na.length>0||(a!==T?(oa.SetUp="1",oa.FEN=a):(delete oa.SetUp,delete oa.FEN))}function i(a){var b=ga[ea[a]];return b?{type:b.type,color:b.color}:null}function j(a,b){if(!("type"in a&&"color"in a))return!1;if(-1===S.indexOf(a.type.toLowerCase()))return!1;if(!(b in ea))return!1;var c=ea[b];return a.type==R&&ha[a.color]!=L&&ha[a.color]!=c?!1:(ga[c]={type:a.type,color:a.color},a.type===R&&(ha[a.color]=c),h(f()),!0)}function k(a){var b=i(a);return ga[ea[a]]=null,b&&b.type===R&&(ha[b.color]=L),h(f()),b}function l(a,b,c,d,e){var f={color:ia,from:b,to:c,flags:d,piece:a[b].type};return e&&(f.flags|=_.PROMOTION,f.promotion=e),a[c]?f.captured=a[c].type:d&_.EP_CAPTURE&&(f.captured=M),f}function m(a){function b(a,b,c,d,e){if(a[c].type!==M||A(d)!==da&&A(d)!==aa)b.push(l(a,c,d,e));else for(var f=[Q,P,O,N],g=0,h=f.length;h>g;g++)b.push(l(a,c,d,e,f[g]))}var c=[],d=ia,e=D(d),f={b:ca,w:ba},g=ea.a8,h=ea.h1,i=!1,j="undefined"!=typeof a&&"legal"in a?a.legal:!0;if("undefined"!=typeof a&&"square"in a){if(!(a.square in ea))return[];g=h=ea[a.square],i=!0}for(var k=g;h>=k;k++)if(136&k)k+=7;else{var m=ga[k];if(null!=m&&m.color===d)if(m.type===M){var n=k+V[d][0];if(null==ga[n]){b(ga,c,k,n,_.NORMAL);var n=k+V[d][1];f[d]===A(k)&&null==ga[n]&&b(ga,c,k,n,_.BIG_PAWN)}for(q=2;4>q;q++){var n=k+V[d][q];136&n||(null!=ga[n]&&ga[n].color===e?b(ga,c,k,n,_.CAPTURE):n===ka&&b(ga,c,k,ka,_.EP_CAPTURE))}}else for(var q=0,r=W[m.type].length;r>q;q++)for(var s=W[m.type][q],n=k;;){if(n+=s,136&n)break;if(null!=ga[n]){if(ga[n].color===d)break;b(ga,c,k,n,_.CAPTURE);break}if(b(ga,c,k,n,_.NORMAL),"n"===m.type||"k"===m.type)break}}if(!i||h===ha[d]){if(ja[d]&_.KSIDE_CASTLE){var t=ha[d],u=t+2;null!=ga[t+1]||null!=ga[u]||o(e,ha[d])||o(e,t+1)||o(e,u)||b(ga,c,ha[d],u,_.KSIDE_CASTLE)}if(ja[d]&_.QSIDE_CASTLE){var t=ha[d],u=t-2;null!=ga[t-1]||null!=ga[t-2]||null!=ga[t-3]||o(e,ha[d])||o(e,t-1)||o(e,u)||b(ga,c,ha[d],u,_.QSIDE_CASTLE)}}if(!j)return c;for(var v=[],k=0,r=c.length;r>k;k++)w(c[k]),p(d)||v.push(c[k]),x();return v}function n(a){var b="";if(a.flags&_.KSIDE_CASTLE)b="O-O";else if(a.flags&_.QSIDE_CASTLE)b="O-O-O";else{var c=y(a);a.piece!==M&&(b+=a.piece.toUpperCase()+c),a.flags&(_.CAPTURE|_.EP_CAPTURE)&&(a.piece===M&&(b+=C(a.from)[0]),b+="x"),b+=C(a.to),a.flags&_.PROMOTION&&(b+="="+a.promotion.toUpperCase())}return w(a),q()&&(b+=r()?"#":"+"),x(),b}function o(a,b){for(var c=ea.a8;c<=ea.h1;c++)if(136&c)c+=7;else if(null!=ga[c]&&ga[c].color===a){var d=ga[c],e=c-b,f=e+119;if(X[f]&1<<Z[d.type]){if(d.type===M){if(e>0){if(d.color===K)return!0}else if(d.color===J)return!0;continue}if("n"===d.type||"k"===d.type)return!0;for(var g=Y[f],h=c+g,i=!1;h!==b;){if(null!=ga[h]){i=!0;break}h+=g}if(!i)return!0}}return!1}function p(a){return o(D(a),ha[a])}function q(){return p(ia)}function r(){return q()&&0===m().length}function s(){return!q()&&0===m().length}function t(){for(var a={},b=[],c=0,d=0,e=ea.a8;e<=ea.h1;e++)if(d=(d+1)%2,136&e)e+=7;else{var f=ga[e];f&&(a[f.type]=f.type in a?a[f.type]+1:1,f.type===O&&b.push(d),c++)}if(2===c)return!0;if(3===c&&(1===a[O]||1===a[N]))return!0;if(c===a[O]+2){for(var g=0,h=b.length,e=0;h>e;e++)g+=b[e];if(0===g||g===h)return!0}return!1}function u(){for(var a=[],b={},c=!1;;){var d=x();if(!d)break;a.push(d)}for(;;){var e=f().split(" ").slice(0,4).join(" ");if(b[e]=e in b?b[e]+1:1,b[e]>=3&&(c=!0),!a.length)break;w(a.pop())}return c}function v(a){na.push({move:a,kings:{b:ha.b,w:ha.w},turn:ia,castling:{b:ja.b,w:ja.w},ep_square:ka,half_moves:la,move_number:ma})}function w(a){var b=ia,c=D(b);if(v(a),ga[a.to]=ga[a.from],ga[a.from]=null,a.flags&_.EP_CAPTURE&&(ia===J?ga[a.to-16]=null:ga[a.to+16]=null),a.flags&_.PROMOTION&&(ga[a.to]={type:a.promotion,color:b}),ga[a.to].type===R){if(ha[ga[a.to].color]=a.to,a.flags&_.KSIDE_CASTLE){var d=a.to-1,e=a.to+1;ga[d]=ga[e],ga[e]=null}else if(a.flags&_.QSIDE_CASTLE){var d=a.to+1,e=a.to-2;ga[d]=ga[e],ga[e]=null}ja[b]=""}if(ja[b])for(var f=0,g=fa[b].length;g>f;f++)if(a.from===fa[b][f].square&&ja[b]&fa[b][f].flag){ja[b]^=fa[b][f].flag;break}if(ja[c])for(var f=0,g=fa[c].length;g>f;f++)if(a.to===fa[c][f].square&&ja[c]&fa[c][f].flag){ja[c]^=fa[c][f].flag;break}ka=a.flags&_.BIG_PAWN?"b"===ia?a.to-16:a.to+16:L,a.piece===M?la=0:a.flags&(_.CAPTURE|_.EP_CAPTURE)?la=0:la++,ia===J&&ma++,ia=D(ia)}function x(){var a=na.pop();if(null==a)return null;var b=a.move;ha=a.kings,ia=a.turn,ja=a.castling,ka=a.ep_square,la=a.half_moves,ma=a.move_number;var c=ia,d=D(ia);if(ga[b.from]=ga[b.to],ga[b.from].type=b.piece,ga[b.to]=null,b.flags&_.CAPTURE)ga[b.to]={type:b.captured,color:d};else if(b.flags&_.EP_CAPTURE){var e;e=c===J?b.to-16:b.to+16,ga[e]={type:M,color:d}}if(b.flags&(_.KSIDE_CASTLE|_.QSIDE_CASTLE)){var f,g;b.flags&_.KSIDE_CASTLE?(f=b.to+1,g=b.to-1):b.flags&_.QSIDE_CASTLE&&(f=b.to-2,g=b.to+1),ga[f]=ga[g],ga[g]=null}return b}function y(a){for(var b=m(),c=a.from,d=a.to,e=a.piece,f=0,g=0,h=0,i=0,j=b.length;j>i;i++){var k=b[i].from,l=b[i].to,n=b[i].piece;e===n&&c!==k&&d===l&&(f++,A(c)===A(k)&&g++,B(c)===B(k)&&h++)}return f>0?g>0&&h>0?C(c):h>0?C(c).charAt(1):C(c).charAt(0):""}function z(){for(var a="   +------------------------+\n",b=ea.a8;b<=ea.h1;b++){if(0===B(b)&&(a+=" "+"87654321"[A(b)]+" |"),null==ga[b])a+=" . ";else{var c=ga[b].type,d=ga[b].color,e=d===K?c.toUpperCase():c.toLowerCase();a+=" "+e+" "}b+1&136&&(a+="|\n",b+=8)}return a+="   +------------------------+\n",a+="     a  b  c  d  e  f  g  h\n"}function A(a){return a>>4}function B(a){return 15&a}function C(a){var b=B(a),c=A(a);return"abcdefgh".substring(b,b+1)+"87654321".substring(c,c+1)}function D(a){return a===K?J:K}function E(a){return-1!=="0123456789".indexOf(a)}function F(a){var b=G(a);b.san=n(b),b.to=C(b.to),b.from=C(b.from);var c="";for(var d in _)_[d]&b.flags&&(c+=$[d]);return b.flags=c,b}function G(a){var b=a instanceof Array?[]:{};for(var c in a)"object"==typeof c?b[c]=G(a[c]):b[c]=a[c];return b}function H(a){return a.replace(/^\s+|\s+$/g,"")}function I(a){for(var b=m({legal:!1}),c=0,d=ia,e=0,f=b.length;f>e;e++){if(w(b[e]),!p(d))if(a-1>0){var g=I(a-1);c+=g}else c++;x()}return c}var J="b",K="w",L=-1,M="p",N="n",O="b",P="r",Q="q",R="k",S="pnbrqkPNBRQK",T="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",U=["1-0","0-1","1/2-1/2","*"],V={b:[16,32,17,15],w:[-16,-32,-17,-15]},W={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},X=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Y=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Z={p:0,n:1,b:2,r:3,q:4,k:5},$={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},_={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},aa=7,ba=6,ca=1,da=0,ea={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},fa={w:[{square:ea.a1,flag:_.QSIDE_CASTLE},{square:ea.h1,flag:_.KSIDE_CASTLE}],b:[{square:ea.a8,flag:_.QSIDE_CASTLE},{square:ea.h8,flag:_.KSIDE_CASTLE}]},ga=new Array(128),ha={w:L,b:L},ia=K,ja={w:0,b:0},ka=L,la=0,ma=1,na=[],oa={};return d("undefined"==typeof a?T:a),{WHITE:K,BLACK:J,PAWN:M,KNIGHT:N,BISHOP:O,ROOK:P,QUEEN:Q,KING:R,SQUARES:function(){for(var a=[],b=ea.a8;b<=ea.h1;b++)136&b?b+=7:a.push(C(b));return a}(),FLAGS:$,load:function(a){return d(a)},reset:function(){return c()},moves:function(a){for(var b=m(a),c=[],d=0,e=b.length;e>d;d++)"undefined"!=typeof a&&"verbose"in a&&a.verbose?c.push(F(b[d])):c.push(n(b[d]));return c},in_check:function(){return q()},in_checkmate:function(){return r()},in_stalemate:function(){return s()},in_draw:function(){return la>=100||s()||t()||u()},insufficient_material:function(){return t()},in_threefold_repetition:function(){return u()},game_over:function(){return la>=100||r()||s()||t()||u()},validate_fen:function(a){return e(a)},fen:function(){return f()},pgn:function(a){var b="object"==typeof a&&"string"==typeof a.newline_char?a.newline_char:"\n",c="object"==typeof a&&"number"==typeof a.max_width?a.max_width:0,d=[],e=!1;for(var f in oa)d.push("["+f+' "'+oa[f]+'"]'+b),e=!0;e&&na.length&&d.push(b);for(var g=[];na.length>0;)g.push(x());for(var h=[],i="";g.length>0;){var j=g.pop();na.length||"b"!==j.color?"w"===j.color&&(i.length&&h.push(i),i=ma+"."):i=ma+". ...",i=i+" "+n(j),w(j)}if(i.length&&h.push(i),"undefined"!=typeof oa.Result&&h.push(oa.Result),0===c)return d.join("")+h.join(" ");for(var k=0,f=0;f<h.length;f++)k+h[f].length>c&&0!==f?(" "===d[d.length-1]&&d.pop(),d.push(b),k=0):0!==f&&(d.push(" "),k++),d.push(h[f]),k+=h[f].length;return d.join("")},load_pgn:function(a,b){function e(a){return a.replace(/\\/g,"\\")}function f(a){for(var b=a.replace(/=/,"").replace(/[+#]?[?!]*$/,""),c=m(),d=0,e=c.length;e>d;d++)if(b===n(c[d]).replace(/=/,"").replace(/[+#]?[?!]*$/,""))return c[d];return null}function h(a){return f(H(a))}function i(a){var b=!1;for(var c in a)b=!0;return b}function j(a,b){for(var c="object"==typeof b&&"string"==typeof b.newline_char?b.newline_char:"\r?\n",d={},f=a.split(new RegExp(e(c))),g="",h="",i=0;i<f.length;i++)g=f[i].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),h=f[i].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),H(g).length>0&&(d[g]=h);return d}var k="object"==typeof b&&"string"==typeof b.newline_char?b.newline_char:"\r?\n",l=new RegExp("^(\\[(.|"+e(k)+")*\\])("+e(k)+")*1.("+e(k)+"|.)*$","g"),o=a.replace(l,"$1");"["!==o[0]&&(o=""),c();var p=j(o,b);for(var q in p)g([q,p[q]]);if("1"===p.SetUp&&!("FEN"in p&&d(p.FEN)))return!1;var r=a.replace(o,"").replace(new RegExp(e(k),"g")," ");r=r.replace(/(\{[^}]+\})+?/g,"");for(var s=/(\([^\(\)]+\))+?/g;s.test(r);)r=r.replace(s,"");r=r.replace(/\d+\.(\.\.)?/g,""),r=r.replace(/\.\.\./g,""),r=r.replace(/\$\d+/g,"");var t=H(r).split(new RegExp(/\s+/));t=t.join(",").replace(/,,+/g,",").split(",");for(var u="",v=0;v<t.length-1;v++){if(u=h(t[v]),null==u)return!1;w(u)}if(u=t[t.length-1],U.indexOf(u)>-1)i(oa)&&"undefined"==typeof oa.Result&&g(["Result",u]);else{if(u=h(u),null==u)return!1;w(u)}return!0},header:function(){return g(arguments)},ascii:function(){return z()},turn:function(){return ia},move:function(a){var b=null,c=m();if("string"==typeof a){for(var d=a.replace(/=/,"").replace(/[+#]?[?!]*$/,""),e=0,f=c.length;f>e;e++)if(d===n(c[e]).replace(/=/,"").replace(/[+#]?[?!]*$/,"")){b=c[e];break}}else if("object"==typeof a)for(var e=0,f=c.length;f>e;e++)if(!(a.from!==C(c[e].from)||a.to!==C(c[e].to)||"promotion"in c[e]&&a.promotion!==c[e].promotion)){b=c[e];break}if(!b)return null;var g=F(b);return w(b),g},undo:function(){var a=x();return a?F(a):null},clear:function(){return b()},put:function(a,b){return j(a,b)},get:function(a){return i(a)},remove:function(a){return k(a)},perft:function(a){return I(a)},square_color:function(a){if(a in ea){var b=ea[a];return(A(b)+B(b))%2===0?"light":"dark"}return null},history:function(a){for(var b=[],c=[],d=("undefined"!=typeof a&&"verbose"in a&&a.verbose);na.length>0;)b.push(x());for(;b.length>0;){var e=b.pop();d?c.push(F(e)):c.push(n(e)),w(e)}return c}}};"undefined"!=typeof c&&(c.Chess=d),"undefined"!=typeof define&&define(function(){return d})},{}],4:[function(a,b,c){b.exports.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,b.exports.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,b.exports.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate},{}],5:[function(a,b,c){function d(a,b,c){return this instanceof d?(f.call(this),this.options=e.extend({serialization:"binary",reliable:!1},c),this.open=!1,this.type="data",this.peer=a,this.provider=b,this.id=this.options.connectionId||d._idPrefix+e.randomToken(),this.label=this.options.label||this.id,this.metadata=this.options.metadata,this.serialization=this.options.serialization,this.reliable=this.options.reliable,this._buffer=[],this._buffering=!1,this.bufferSize=0,this._chunkedData={},this.options._payload&&(this._peerBrowser=this.options._payload.browser),void g.startConnection(this,this.options._payload||{originator:!0})):new d(a,b,c)}var e=a("./util"),f=a("eventemitter3"),g=a("./negotiator"),h=a("reliable");e.inherits(d,f),d._idPrefix="dc_",d.prototype.initialize=function(a){this._dc=this.dataChannel=a,this._configureDataChannel()},d.prototype._configureDataChannel=function(){var a=this;e.supports.sctp&&(this._dc.binaryType="arraybuffer"),this._dc.onopen=function(){e.log("Data channel connection success"),a.open=!0,a.emit("open")},!e.supports.sctp&&this.reliable&&(this._reliable=new h(this._dc,e.debug)),this._reliable?this._reliable.onmessage=function(b){a.emit("data",b)}:this._dc.onmessage=function(b){a._handleDataMessage(b)},this._dc.onclose=function(b){e.log("DataChannel closed for:",a.peer),a.close()}},d.prototype._handleDataMessage=function(a){var b=this,c=a.data,d=c.constructor;if("binary"===this.serialization||"binary-utf8"===this.serialization){if(d===Blob)return void e.blobToArrayBuffer(c,function(a){c=e.unpack(a),b.emit("data",c)});if(d===ArrayBuffer)c=e.unpack(c);else if(d===String){var f=e.binaryStringToArrayBuffer(c);c=e.unpack(f)}}else"json"===this.serialization&&(c=JSON.parse(c));if(c.__peerData){var g=c.__peerData,h=this._chunkedData[g]||{data:[],count:0,total:c.total};return h.data[c.n]=c.data,h.count+=1,h.total===h.count&&(delete this._chunkedData[g],c=new Blob(h.data),this._handleDataMessage({data:c})),void(this._chunkedData[g]=h)}this.emit("data",c)},d.prototype.close=function(){this.open&&(this.open=!1,g.cleanup(this),this.emit("close"))},d.prototype.send=function(a,b){if(!this.open)return void this.emit("error",new Error("Connection is not open. You should listen for the `open` event before sending messages."));if(this._reliable)return void this._reliable.send(a);var c=this;if("json"===this.serialization)this._bufferedSend(JSON.stringify(a));else if("binary"===this.serialization||"binary-utf8"===this.serialization){var d=e.pack(a),f=e.chunkedBrowsers[this._peerBrowser]||e.chunkedBrowsers[e.browser];if(f&&!b&&d.size>e.chunkedMTU)return void this._sendChunks(d);e.supports.sctp?e.supports.binaryBlob?this._bufferedSend(d):e.blobToArrayBuffer(d,function(a){c._bufferedSend(a)}):e.blobToBinaryString(d,function(a){c._bufferedSend(a)})}else this._bufferedSend(a)},d.prototype._bufferedSend=function(a){(this._buffering||!this._trySend(a))&&(this._buffer.push(a),this.bufferSize=this._buffer.length)},d.prototype._trySend=function(a){try{this._dc.send(a)}catch(b){this._buffering=!0;var c=this;return setTimeout(function(){c._buffering=!1,c._tryBuffer()},100),!1}return!0},d.prototype._tryBuffer=function(){if(0!==this._buffer.length){var a=this._buffer[0];this._trySend(a)&&(this._buffer.shift(),this.bufferSize=this._buffer.length,this._tryBuffer())}},d.prototype._sendChunks=function(a){for(var b=e.chunk(a),c=0,d=b.length;d>c;c+=1){var a=b[c];this.send(a,!0)}},d.prototype.handleMessage=function(a){var b=a.payload;switch(a.type){case"ANSWER":this._peerBrowser=b.browser,g.handleSDP(a.type,this,b.sdp);break;case"CANDIDATE":g.handleCandidate(this,b.candidate);break;default:e.warn("Unrecognized message type:",a.type,"from peer:",this.peer)}},b.exports=d},{"./negotiator":7,"./util":10,eventemitter3:11,reliable:14}],6:[function(a,b,c){function d(a,b,c){return this instanceof d?(f.call(this),this.options=e.extend({},c),this.open=!1,this.type="media",this.peer=a,this.provider=b,this.metadata=this.options.metadata,this.localStream=this.options._stream,this.id=this.options.connectionId||d._idPrefix+e.randomToken(),void(this.localStream&&g.startConnection(this,{_stream:this.localStream,originator:!0}))):new d(a,b,c)}var e=a("./util"),f=a("eventemitter3"),g=a("./negotiator");e.inherits(d,f),d._idPrefix="mc_",d.prototype.addStream=function(a){e.log("Receiving stream",a),this.remoteStream=a,this.emit("stream",a)},d.prototype.handleMessage=function(a){var b=a.payload;switch(a.type){case"ANSWER":g.handleSDP(a.type,this,b.sdp),this.open=!0;break;case"CANDIDATE":g.handleCandidate(this,b.candidate);break;default:e.warn("Unrecognized message type:",a.type,"from peer:",this.peer)}},d.prototype.answer=function(a){if(this.localStream)return void e.warn("Local stream already exists on this MediaConnection. Are you answering a call twice?");this.options._payload._stream=a,this.localStream=a,g.startConnection(this,this.options._payload);for(var b=this.provider._getMessages(this.id),c=0,d=b.length;d>c;c+=1)this.handleMessage(b[c]);this.open=!0},d.prototype.close=function(){this.open&&(this.open=!1,g.cleanup(this),this.emit("close"))},b.exports=d},{"./negotiator":7,"./util":10,eventemitter3:11}],7:[function(a,b,c){var d=a("./util"),e=a("./adapter").RTCPeerConnection,f=a("./adapter").RTCSessionDescription,g=a("./adapter").RTCIceCandidate,h={pcs:{data:{},media:{}},queue:[]};h._idPrefix="pc_",h.startConnection=function(a,b){var c=h._getPeerConnection(a,b);if("media"===a.type&&b._stream&&c.addStream(b._stream),a.pc=a.peerConnection=c,b.originator){if("data"===a.type){var e={};d.supports.sctp||(e={reliable:b.reliable});var f=c.createDataChannel(a.label,e);a.initialize(f)}d.supports.onnegotiationneeded||h._makeOffer(a)}else h.handleSDP("OFFER",a,b.sdp)},h._getPeerConnection=function(a,b){h.pcs[a.type]||d.error(a.type+" is not a valid connection type. Maybe you overrode the `type` property somewhere."),h.pcs[a.type][a.peer]||(h.pcs[a.type][a.peer]={});var c;h.pcs[a.type][a.peer];return b.pc&&(c=h.pcs[a.type][a.peer][b.pc]),c&&"stable"===c.signalingState||(c=h._startPeerConnection(a)),c},h._startPeerConnection=function(a){d.log("Creating RTCPeerConnection.");var b=h._idPrefix+d.randomToken(),c={};"data"!==a.type||d.supports.sctp?"media"===a.type&&(c={optional:[{DtlsSrtpKeyAgreement:!0}]}):c={optional:[{RtpDataChannels:!0}]};var f=new e(a.provider.options.config,c);return h.pcs[a.type][a.peer][b]=f,h._setupListeners(a,f,b),f},h._setupListeners=function(a,b,c){var e=a.peer,f=a.id,g=a.provider;d.log("Listening for ICE candidates."),b.onicecandidate=function(b){b.candidate&&(d.log("Received ICE candidates for:",a.peer),g.socket.send({type:"CANDIDATE",payload:{candidate:b.candidate,type:a.type,connectionId:a.id},dst:e}))},b.oniceconnectionstatechange=function(){switch(b.iceConnectionState){case"disconnected":case"failed":d.log("iceConnectionState is disconnected, closing connections to "+e),a.close();break;case"completed":b.onicecandidate=d.noop}},b.onicechange=b.oniceconnectionstatechange,d.log("Listening for `negotiationneeded`"),b.onnegotiationneeded=function(){d.log("`negotiationneeded` triggered"),"stable"==b.signalingState?h._makeOffer(a):d.log("onnegotiationneeded triggered when not stable. Is another connection being established?")},d.log("Listening for data channel"),b.ondatachannel=function(a){d.log("Received data channel");var b=a.channel,c=g.getConnection(e,f);c.initialize(b)},d.log("Listening for remote stream"),b.onaddstream=function(a){d.log("Received remote stream");var b=a.stream,c=g.getConnection(e,f);"media"===c.type&&c.addStream(b)}},h.cleanup=function(a){d.log("Cleaning up PeerConnection to "+a.peer);var b=a.pc;!b||"closed"===b.readyState&&"closed"===b.signalingState||(b.close(),a.pc=null)},h._makeOffer=function(a){var b=a.pc;b.createOffer(function(c){d.log("Created offer."),!d.supports.sctp&&"data"===a.type&&a.reliable&&(c.sdp=Reliable.higherBandwidthSDP(c.sdp)),b.setLocalDescription(c,function(){d.log("Set localDescription: offer","for:",a.peer),a.provider.socket.send({type:"OFFER",payload:{sdp:c,type:a.type,label:a.label,connectionId:a.id,reliable:a.reliable,serialization:a.serialization,metadata:a.metadata,browser:d.browser},dst:a.peer})},function(b){a.provider.emitError("webrtc",b),d.log("Failed to setLocalDescription, ",b)})},function(b){a.provider.emitError("webrtc",b),d.log("Failed to createOffer, ",b)},a.options.constraints)},h._makeAnswer=function(a){
var b=a.pc;b.createAnswer(function(c){d.log("Created answer."),!d.supports.sctp&&"data"===a.type&&a.reliable&&(c.sdp=Reliable.higherBandwidthSDP(c.sdp)),b.setLocalDescription(c,function(){d.log("Set localDescription: answer","for:",a.peer),a.provider.socket.send({type:"ANSWER",payload:{sdp:c,type:a.type,connectionId:a.id,browser:d.browser},dst:a.peer})},function(b){a.provider.emitError("webrtc",b),d.log("Failed to setLocalDescription, ",b)})},function(b){a.provider.emitError("webrtc",b),d.log("Failed to create answer, ",b)})},h.handleSDP=function(a,b,c){c=new f(c);var e=b.pc;d.log("Setting remote description",c),e.setRemoteDescription(c,function(){d.log("Set remoteDescription:",a,"for:",b.peer),"OFFER"===a&&h._makeAnswer(b)},function(a){b.provider.emitError("webrtc",a),d.log("Failed to setRemoteDescription, ",a)})},h.handleCandidate=function(a,b){var c=b.candidate,e=b.sdpMLineIndex;a.pc.addIceCandidate(new g({sdpMLineIndex:e,candidate:c})),d.log("Added ICE candidate for:",a.peer)},b.exports=h},{"./adapter":4,"./util":10}],8:[function(a,b,c){function d(a,b){return this instanceof d?(f.call(this),a&&a.constructor==Object?(b=a,a=void 0):a&&(a=a.toString()),b=e.extend({debug:0,host:e.CLOUD_HOST,port:e.CLOUD_PORT,key:"peerjs",path:"/",token:e.randomToken(),config:e.defaultConfig},b),this.options=b,"/"===b.host&&(b.host=window.location.hostname),"/"!==b.path[0]&&(b.path="/"+b.path),"/"!==b.path[b.path.length-1]&&(b.path+="/"),void 0===b.secure&&b.host!==e.CLOUD_HOST&&(b.secure=e.isSecure()),b.logFunction&&e.setLogFunction(b.logFunction),e.setLogLevel(b.debug),e.supports.audioVideo||e.supports.data?e.validateId(a)?e.validateKey(b.key)?b.secure&&"0.peerjs.com"===b.host?void this._delayedAbort("ssl-unavailable","The cloud server currently does not support HTTPS. Please run your own PeerServer to use HTTPS."):(this.destroyed=!1,this.disconnected=!1,this.open=!1,this.connections={},this._lostMessages={},this._initializeServerConnection(),void(a?this._initialize(a):this._retrieveId())):void this._delayedAbort("invalid-key",'API KEY "'+b.key+'" is invalid'):void this._delayedAbort("invalid-id",'ID "'+a+'" is invalid'):void this._delayedAbort("browser-incompatible","The current browser does not support WebRTC")):new d(a,b)}var e=a("./util"),f=a("eventemitter3"),g=a("./socket"),h=a("./mediaconnection"),i=a("./dataconnection");e.inherits(d,f),d.prototype._initializeServerConnection=function(){var a=this;this.socket=new g(this.options.secure,this.options.host,this.options.port,this.options.path,this.options.key),this.socket.on("message",function(b){a._handleMessage(b)}),this.socket.on("error",function(b){a._abort("socket-error",b)}),this.socket.on("disconnected",function(){a.disconnected||(a.emitError("network","Lost connection to server."),a.disconnect())}),this.socket.on("close",function(){a.disconnected||a._abort("socket-closed","Underlying socket is already closed.")})},d.prototype._retrieveId=function(a){var b=this,c=new XMLHttpRequest,d=this.options.secure?"https://":"http://",f=d+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/id",g="?ts="+(new Date).getTime()+Math.random();f+=g,c.open("get",f,!0),c.onerror=function(a){e.error("Error retrieving ID",a);var c="";"/"===b.options.path&&b.options.host!==e.CLOUD_HOST&&(c=" If you passed in a `path` to your self-hosted PeerServer, you'll also need to pass in that same path when creating a new Peer."),b._abort("server-error","Could not get an ID from the server."+c)},c.onreadystatechange=function(){return 4===c.readyState?200!==c.status?void c.onerror():void b._initialize(c.responseText):void 0},c.send(null)},d.prototype._initialize=function(a){this.id=a,this.socket.start(this.id,this.options.token)},d.prototype._handleMessage=function(a){var b,c=a.type,d=a.payload,f=a.src;switch(c){case"OPEN":this.emit("open",this.id),this.open=!0;break;case"ERROR":this._abort("server-error",d.msg);break;case"ID-TAKEN":this._abort("unavailable-id","ID `"+this.id+"` is taken");break;case"INVALID-KEY":this._abort("invalid-key",'API KEY "'+this.options.key+'" is invalid');break;case"LEAVE":e.log("Received leave message from",f),this._cleanupPeer(f);break;case"EXPIRE":this.emitError("peer-unavailable","Could not connect to peer "+f);break;case"OFFER":var g=d.connectionId;if(b=this.getConnection(f,g))e.warn("Offer received for existing Connection ID:",g);else{if("media"===d.type)b=new h(f,this,{connectionId:g,_payload:d,metadata:d.metadata}),this._addConnection(f,b),this.emit("call",b);else{if("data"!==d.type)return void e.warn("Received malformed connection type:",d.type);b=new i(f,this,{connectionId:g,_payload:d,metadata:d.metadata,label:d.label,serialization:d.serialization,reliable:d.reliable}),this._addConnection(f,b),this.emit("connection",b)}for(var j=this._getMessages(g),k=0,l=j.length;l>k;k+=1)b.handleMessage(j[k])}break;default:if(!d)return void e.warn("You received a malformed message from "+f+" of type "+c);var m=d.connectionId;b=this.getConnection(f,m),b&&b.pc?b.handleMessage(a):m?this._storeMessage(m,a):e.warn("You received an unrecognized message:",a)}},d.prototype._storeMessage=function(a,b){this._lostMessages[a]||(this._lostMessages[a]=[]),this._lostMessages[a].push(b)},d.prototype._getMessages=function(a){var b=this._lostMessages[a];return b?(delete this._lostMessages[a],b):[]},d.prototype.connect=function(a,b){if(this.disconnected)return e.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect, or call reconnect on this peer if you believe its ID to still be available."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");var c=new i(a,this,b);return this._addConnection(a,c),c},d.prototype.call=function(a,b,c){if(this.disconnected)return e.warn("You cannot connect to a new Peer because you called .disconnect() on this Peer and ended your connection with the server. You can create a new Peer to reconnect."),void this.emitError("disconnected","Cannot connect to new Peer after disconnecting from server.");if(!b)return void e.error("To call a peer, you must provide a stream from your browser's `getUserMedia`.");c=c||{},c._stream=b;var d=new h(a,this,c);return this._addConnection(a,d),d},d.prototype._addConnection=function(a,b){this.connections[a]||(this.connections[a]=[]),this.connections[a].push(b)},d.prototype.getConnection=function(a,b){var c=this.connections[a];if(!c)return null;for(var d=0,e=c.length;e>d;d++)if(c[d].id===b)return c[d];return null},d.prototype._delayedAbort=function(a,b){var c=this;e.setZeroTimeout(function(){c._abort(a,b)})},d.prototype._abort=function(a,b){e.error("Aborting!"),this._lastServerId?this.disconnect():this.destroy(),this.emitError(a,b)},d.prototype.emitError=function(a,b){e.error("Error:",b),"string"==typeof b&&(b=new Error(b)),b.type=a,this.emit("error",b)},d.prototype.destroy=function(){this.destroyed||(this._cleanup(),this.disconnect(),this.destroyed=!0)},d.prototype._cleanup=function(){if(this.connections)for(var a=Object.keys(this.connections),b=0,c=a.length;c>b;b++)this._cleanupPeer(a[b]);this.emit("close")},d.prototype._cleanupPeer=function(a){for(var b=this.connections[a],c=0,d=b.length;d>c;c+=1)b[c].close()},d.prototype.disconnect=function(){var a=this;e.setZeroTimeout(function(){a.disconnected||(a.disconnected=!0,a.open=!1,a.socket&&a.socket.close(),a.emit("disconnected",a.id),a._lastServerId=a.id,a.id=null)})},d.prototype.reconnect=function(){if(this.disconnected&&!this.destroyed)e.log("Attempting reconnection to server with ID "+this._lastServerId),this.disconnected=!1,this._initializeServerConnection(),this._initialize(this._lastServerId);else{if(this.destroyed)throw new Error("This peer cannot reconnect to the server. It has already been destroyed.");if(this.disconnected||this.open)throw new Error("Peer "+this.id+" cannot reconnect because it is not disconnected from the server!");e.error("In a hurry? We're still trying to make the initial connection!")}},d.prototype.listAllPeers=function(a){a=a||function(){};var b=this,c=new XMLHttpRequest,d=this.options.secure?"https://":"http://",f=d+this.options.host+":"+this.options.port+this.options.path+this.options.key+"/peers",g="?ts="+(new Date).getTime()+Math.random();f+=g,c.open("get",f,!0),c.onerror=function(c){b._abort("server-error","Could not get peers from the server."),a([])},c.onreadystatechange=function(){if(4===c.readyState){if(401===c.status){var d="";throw d=b.options.host!==e.CLOUD_HOST?"It looks like you're using the cloud server. You can email team@peerjs.com to enable peer listing for your API key.":"You need to enable `allow_discovery` on your self-hosted PeerServer to use this feature.",a([]),new Error("It doesn't look like you have permission to list peers IDs. "+d)}a(200!==c.status?[]:JSON.parse(c.responseText))}},c.send(null)},b.exports=d},{"./dataconnection":5,"./mediaconnection":6,"./socket":9,"./util":10,eventemitter3:11}],9:[function(a,b,c){function d(a,b,c,e,g){if(!(this instanceof d))return new d(a,b,c,e,g);f.call(this),this.disconnected=!1,this._queue=[];var h=a?"https://":"http://",i=a?"wss://":"ws://";this._httpUrl=h+b+":"+c+e+g,this._wsUrl=i+b+":"+c+e+"peerjs?key="+g}var e=a("./util"),f=a("eventemitter3");e.inherits(d,f),d.prototype.start=function(a,b){this.id=a,this._httpUrl+="/"+a+"/"+b,this._wsUrl+="&id="+a+"&token="+b,this._startXhrStream(),this._startWebSocket()},d.prototype._startWebSocket=function(a){var b=this;this._socket||(this._socket=new WebSocket(this._wsUrl),this._socket.onmessage=function(a){try{var c=JSON.parse(a.data)}catch(d){return void e.log("Invalid server message",a.data)}b.emit("message",c)},this._socket.onclose=function(a){e.log("Socket closed."),b.disconnected=!0,b.emit("disconnected")},this._socket.onopen=function(){b._timeout&&(clearTimeout(b._timeout),setTimeout(function(){b._http.abort(),b._http=null},5e3)),b._sendQueuedMessages(),e.log("Socket open")})},d.prototype._startXhrStream=function(a){try{var b=this;this._http=new XMLHttpRequest,this._http._index=1,this._http._streamIndex=a||0,this._http.open("post",this._httpUrl+"/id?i="+this._http._streamIndex,!0),this._http.onerror=function(){clearTimeout(b._timeout),b.emit("disconnected")},this._http.onreadystatechange=function(){2==this.readyState&&this.old?(this.old.abort(),delete this.old):this.readyState>2&&200===this.status&&this.responseText&&b._handleStream(this)},this._http.send(null),this._setHTTPTimeout()}catch(c){e.log("XMLHttpRequest not available; defaulting to WebSockets")}},d.prototype._handleStream=function(a){var b=a.responseText.split("\n");if(a._buffer)for(;a._buffer.length>0;){var c=a._buffer.shift(),d=b[c];try{d=JSON.parse(d)}catch(f){a._buffer.shift(c);break}this.emit("message",d)}var g=b[a._index];if(g)if(a._index+=1,a._index===b.length)a._buffer||(a._buffer=[]),a._buffer.push(a._index-1);else{try{g=JSON.parse(g)}catch(f){return void e.log("Invalid server message",g)}this.emit("message",g)}},d.prototype._setHTTPTimeout=function(){var a=this;this._timeout=setTimeout(function(){var b=a._http;a._wsOpen()?b.abort():(a._startXhrStream(b._streamIndex+1),a._http.old=b)},25e3)},d.prototype._wsOpen=function(){return this._socket&&1==this._socket.readyState},d.prototype._sendQueuedMessages=function(){for(var a=0,b=this._queue.length;b>a;a+=1)this.send(this._queue[a])},d.prototype.send=function(a){if(!this.disconnected){if(!this.id)return void this._queue.push(a);if(!a.type)return void this.emit("error","Invalid message");var b=JSON.stringify(a);if(this._wsOpen())this._socket.send(b);else{var c=new XMLHttpRequest,d=this._httpUrl+"/"+a.type.toLowerCase();c.open("post",d,!0),c.setRequestHeader("Content-Type","application/json"),c.send(b)}}},d.prototype.close=function(){!this.disconnected&&this._wsOpen()&&(this._socket.close(),this.disconnected=!0)},b.exports=d},{"./util":10,eventemitter3:11}],10:[function(a,b,c){var d={iceServers:[{url:"stun:stun.l.google.com:19302"}]},e=1,f=a("js-binarypack"),g=a("./adapter").RTCPeerConnection,h={noop:function(){},CLOUD_HOST:"0.peerjs.com",CLOUD_PORT:9e3,chunkedBrowsers:{Chrome:1},chunkedMTU:16300,logLevel:0,setLogLevel:function(a){var b=parseInt(a,10);isNaN(parseInt(a,10))?h.logLevel=a?3:0:h.logLevel=b,h.log=h.warn=h.error=h.noop,h.logLevel>0&&(h.error=h._printWith("ERROR")),h.logLevel>1&&(h.warn=h._printWith("WARNING")),h.logLevel>2&&(h.log=h._print)},setLogFunction:function(a){a.constructor!==Function?h.warn("The log function you passed in is not a function. Defaulting to regular logs."):h._print=a},_printWith:function(a){return function(){var b=Array.prototype.slice.call(arguments);b.unshift(a),h._print.apply(h,b)}},_print:function(){var a=!1,b=Array.prototype.slice.call(arguments);b.unshift("PeerJS: ");for(var c=0,d=b.length;d>c;c++)b[c]instanceof Error&&(b[c]="("+b[c].name+") "+b[c].message,a=!0);a?console.error.apply(console,b):console.log.apply(console,b)},defaultConfig:d,browser:function(){return window.mozRTCPeerConnection?"Firefox":window.webkitRTCPeerConnection?"Chrome":window.RTCPeerConnection?"Supported":"Unsupported"}(),supports:function(){if("undefined"==typeof g)return{};var a,b,c=!0,e=!0,f=!1,i=!1,j=!!window.webkitRTCPeerConnection;try{a=new g(d,{optional:[{RtpDataChannels:!0}]})}catch(k){c=!1,e=!1}if(c)try{b=a.createDataChannel("_PEERJSTEST")}catch(k){c=!1}if(c){try{b.binaryType="blob",f=!0}catch(k){}var l=new g(d,{});try{var m=l.createDataChannel("_PEERJSRELIABLETEST",{});i=m.reliable}catch(k){}l.close()}if(e&&(e=!!a.addStream),!j&&c){var n=new g(d,{optional:[{RtpDataChannels:!0}]});n.onnegotiationneeded=function(){j=!0,h&&h.supports&&(h.supports.onnegotiationneeded=!0)},n.createDataChannel("_PEERJSNEGOTIATIONTEST"),setTimeout(function(){n.close()},1e3)}return a&&a.close(),{audioVideo:e,data:c,binaryBlob:f,binary:i,reliable:i,sctp:i,onnegotiationneeded:j}}(),validateId:function(a){return!a||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(a)},validateKey:function(a){return!a||/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/.exec(a)},debug:!1,inherits:function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},pack:f.pack,unpack:f.unpack,log:function(){if(h.debug){var a=!1,b=Array.prototype.slice.call(arguments);b.unshift("PeerJS: ");for(var c=0,d=b.length;d>c;c++)b[c]instanceof Error&&(b[c]="("+b[c].name+") "+b[c].message,a=!0);a?console.error.apply(console,b):console.log.apply(console,b)}},setZeroTimeout:function(a){function b(b){d.push(b),a.postMessage(e,"*")}function c(b){b.source==a&&b.data==e&&(b.stopPropagation&&b.stopPropagation(),d.length&&d.shift()())}var d=[],e="zero-timeout-message";return a.addEventListener?a.addEventListener("message",c,!0):a.attachEvent&&a.attachEvent("onmessage",c),b}(window),chunk:function(a){for(var b=[],c=a.size,d=index=0,f=Math.ceil(c/h.chunkedMTU);c>d;){var g=Math.min(c,d+h.chunkedMTU),i=a.slice(d,g),j={__peerData:e,n:index,data:i,total:f};b.push(j),d=g,index+=1}return e+=1,b},blobToArrayBuffer:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsArrayBuffer(a)},blobToBinaryString:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsBinaryString(a)},binaryStringToArrayBuffer:function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=255&a.charCodeAt(c);return b.buffer},randomToken:function(){return Math.random().toString(36).substr(2)},isSecure:function(){return"https:"===location.protocol}};b.exports=h},{"./adapter":4,"js-binarypack":12}],11:[function(a,b,c){"use strict";function d(a,b,c){this.fn=a,this.context=b,this.once=c||!1}function e(){}e.prototype._events=void 0,e.prototype.listeners=function(a){if(!this._events||!this._events[a])return[];if(this._events[a].fn)return[this._events[a].fn];for(var b=0,c=this._events[a].length,d=new Array(c);c>b;b++)d[b]=this._events[a][b].fn;return d},e.prototype.emit=function(a,b,c,d,e,f){if(!this._events||!this._events[a])return!1;var g,h,i=this._events[a],j=arguments.length;if("function"==typeof i.fn){switch(i.once&&this.removeListener(a,i.fn,!0),j){case 1:return i.fn.call(i.context),!0;case 2:return i.fn.call(i.context,b),!0;case 3:return i.fn.call(i.context,b,c),!0;case 4:return i.fn.call(i.context,b,c,d),!0;case 5:return i.fn.call(i.context,b,c,d,e),!0;case 6:return i.fn.call(i.context,b,c,d,e,f),!0}for(h=1,g=new Array(j-1);j>h;h++)g[h-1]=arguments[h];i.fn.apply(i.context,g)}else{var k,l=i.length;for(h=0;l>h;h++)switch(i[h].once&&this.removeListener(a,i[h].fn,!0),j){case 1:i[h].fn.call(i[h].context);break;case 2:i[h].fn.call(i[h].context,b);break;case 3:i[h].fn.call(i[h].context,b,c);break;default:if(!g)for(k=1,g=new Array(j-1);j>k;k++)g[k-1]=arguments[k];i[h].fn.apply(i[h].context,g)}}return!0},e.prototype.on=function(a,b,c){var e=new d(b,c||this);return this._events||(this._events={}),this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],e]:this._events[a].push(e):this._events[a]=e,this},e.prototype.once=function(a,b,c){var e=new d(b,c||this,!0);return this._events||(this._events={}),this._events[a]?this._events[a].fn?this._events[a]=[this._events[a],e]:this._events[a].push(e):this._events[a]=e,this},e.prototype.removeListener=function(a,b,c){if(!this._events||!this._events[a])return this;var d=this._events[a],e=[];if(b&&(d.fn&&(d.fn!==b||c&&!d.once)&&e.push(d),!d.fn))for(var f=0,g=d.length;g>f;f++)(d[f].fn!==b||c&&!d[f].once)&&e.push(d[f]);return e.length?this._events[a]=1===e.length?e[0]:e:delete this._events[a],this},e.prototype.removeAllListeners=function(a){return this._events?(a?delete this._events[a]:this._events={},this):this},e.prototype.off=e.prototype.removeListener,e.prototype.addListener=e.prototype.on,e.prototype.setMaxListeners=function(){return this},e.EventEmitter=e,e.EventEmitter2=e,e.EventEmitter3=e,b.exports=e},{}],12:[function(a,b,c){function d(a){this.index=0,this.dataBuffer=a,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function e(){this.bufferBuilder=new h}function f(a){var b=a.charCodeAt(0);return 2047>=b?"00":65535>=b?"000":2097151>=b?"0000":67108863>=b?"00000":"000000"}function g(a){return a.length>600?new Blob([a]).size:a.replace(/[^\u0000-\u007F]/g,f).length}var h=a("./bufferbuilder").BufferBuilder,i=a("./bufferbuilder").binaryFeatures,j={unpack:function(a){var b=new d(a);return b.unpack()},pack:function(a){var b=new e;b.pack(a);var c=b.getBuffer();return c}};b.exports=j,d.prototype.unpack=function(){var a=this.unpack_uint8();if(128>a){var b=a;return b}if(32>(224^a)){var c=(224^a)-32;return c}var d;if((d=160^a)<=15)return this.unpack_raw(d);if((d=176^a)<=15)return this.unpack_string(d);if((d=144^a)<=15)return this.unpack_array(d);if((d=128^a)<=15)return this.unpack_map(d);switch(a){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return d=this.unpack_uint16(),this.unpack_string(d);case 217:return d=this.unpack_uint32(),this.unpack_string(d);case 218:return d=this.unpack_uint16(),this.unpack_raw(d);case 219:return d=this.unpack_uint32(),this.unpack_raw(d);case 220:return d=this.unpack_uint16(),this.unpack_array(d);case 221:return d=this.unpack_uint32(),this.unpack_array(d);case 222:return d=this.unpack_uint16(),this.unpack_map(d);case 223:return d=this.unpack_uint32(),this.unpack_map(d)}},d.prototype.unpack_uint8=function(){var a=255&this.dataView[this.index];return this.index++,a},d.prototype.unpack_uint16=function(){var a=this.read(2),b=256*(255&a[0])+(255&a[1]);return this.index+=2,b},d.prototype.unpack_uint32=function(){var a=this.read(4),b=256*(256*(256*a[0]+a[1])+a[2])+a[3];return this.index+=4,b},d.prototype.unpack_uint64=function(){var a=this.read(8),b=256*(256*(256*(256*(256*(256*(256*a[0]+a[1])+a[2])+a[3])+a[4])+a[5])+a[6])+a[7];return this.index+=8,b},d.prototype.unpack_int8=function(){var a=this.unpack_uint8();return 128>a?a:a-256},d.prototype.unpack_int16=function(){var a=this.unpack_uint16();return 32768>a?a:a-65536},d.prototype.unpack_int32=function(){var a=this.unpack_uint32();return a<Math.pow(2,31)?a:a-Math.pow(2,32)},d.prototype.unpack_int64=function(){var a=this.unpack_uint64();return a<Math.pow(2,63)?a:a-Math.pow(2,64)},d.prototype.unpack_raw=function(a){if(this.length<this.index+a)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+a+" "+this.length);var b=this.dataBuffer.slice(this.index,this.index+a);return this.index+=a,b},d.prototype.unpack_string=function(a){for(var b,c,d=this.read(a),e=0,f="";a>e;)b=d[e],128>b?(f+=String.fromCharCode(b),e++):32>(192^b)?(c=(192^b)<<6|63&d[e+1],f+=String.fromCharCode(c),e+=2):(c=(15&b)<<12|(63&d[e+1])<<6|63&d[e+2],f+=String.fromCharCode(c),e+=3);return this.index+=a,f},d.prototype.unpack_array=function(a){for(var b=new Array(a),c=0;a>c;c++)b[c]=this.unpack();return b},d.prototype.unpack_map=function(a){for(var b={},c=0;a>c;c++){var d=this.unpack(),e=this.unpack();b[d]=e}return b},d.prototype.unpack_float=function(){var a=this.unpack_uint32(),b=a>>31,c=(a>>23&255)-127,d=8388607&a|8388608;return(0==b?1:-1)*d*Math.pow(2,c-23)},d.prototype.unpack_double=function(){var a=this.unpack_uint32(),b=this.unpack_uint32(),c=a>>31,d=(a>>20&2047)-1023,e=1048575&a|1048576,f=e*Math.pow(2,d-20)+b*Math.pow(2,d-52);return(0==c?1:-1)*f},d.prototype.read=function(a){var b=this.index;if(b+a<=this.length)return this.dataView.subarray(b,b+a);throw new Error("BinaryPackFailure: read index out of range")},e.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},e.prototype.pack=function(a){var b=typeof a;if("string"==b)this.pack_string(a);else if("number"==b)Math.floor(a)===a?this.pack_integer(a):this.pack_double(a);else if("boolean"==b)a===!0?this.bufferBuilder.append(195):a===!1&&this.bufferBuilder.append(194);else if("undefined"==b)this.bufferBuilder.append(192);else{if("object"!=b)throw new Error('Type "'+b+'" not yet supported');if(null===a)this.bufferBuilder.append(192);else{var c=a.constructor;if(c==Array)this.pack_array(a);else if(c==Blob||c==File)this.pack_bin(a);else if(c==ArrayBuffer)i.useArrayBufferView?this.pack_bin(new Uint8Array(a)):this.pack_bin(a);else if("BYTES_PER_ELEMENT"in a)i.useArrayBufferView?this.pack_bin(new Uint8Array(a.buffer)):this.pack_bin(a.buffer);else if(c==Object)this.pack_object(a);else if(c==Date)this.pack_string(a.toString());else{if("function"!=typeof a.toBinaryPack)throw new Error('Type "'+c.toString()+'" not yet supported');this.bufferBuilder.append(a.toBinaryPack())}}}this.bufferBuilder.flush()},e.prototype.pack_bin=function(a){var b=a.length||a.byteLength||a.size;if(15>=b)this.pack_uint8(160+b);else if(65535>=b)this.bufferBuilder.append(218),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(b)}this.bufferBuilder.append(a)},e.prototype.pack_string=function(a){var b=g(a);if(15>=b)this.pack_uint8(176+b);else if(65535>=b)this.bufferBuilder.append(216),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(b)}this.bufferBuilder.append(a)},e.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else{if(!(4294967295>=b))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(b)}for(var c=0;b>c;c++)this.pack(a[c])},e.prototype.pack_integer=function(a){if(a>=-32&&127>=a)this.bufferBuilder.append(255&a);else if(a>=0&&255>=a)this.bufferBuilder.append(204),this.pack_uint8(a);else if(a>=-128&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(a>=0&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(a>=-32768&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(a>=0&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(a>=-2147483648&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(a>=-0x8000000000000000&&0x8000000000000000>=a)this.bufferBuilder.append(211),this.pack_int64(a);else{if(!(a>=0&&0x10000000000000000>=a))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(a)}},e.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var c=Math.floor(Math.log(a)/Math.LN2),d=a/Math.pow(2,c)-1,e=Math.floor(d*Math.pow(2,52)),f=Math.pow(2,32),g=b<<31|c+1023<<20|e/f&1048575,h=e%f;this.bufferBuilder.append(203),this.pack_int32(g),this.pack_int32(h)},e.prototype.pack_object=function(a){var b=Object.keys(a),c=b.length;if(15>=c)this.pack_uint8(128+c);else if(65535>=c)this.bufferBuilder.append(222),this.pack_uint16(c);else{if(!(4294967295>=c))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(c)}for(var d in a)a.hasOwnProperty(d)&&(this.pack(d),this.pack(a[d]))},e.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)},e.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8),this.bufferBuilder.append(255&a)},e.prototype.pack_uint32=function(a){var b=4294967295&a;this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b)},e.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)},e.prototype.pack_int8=function(a){this.bufferBuilder.append(255&a)},e.prototype.pack_int16=function(a){this.bufferBuilder.append((65280&a)>>8),this.bufferBuilder.append(255&a)},e.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255),this.bufferBuilder.append((16711680&a)>>>16),this.bufferBuilder.append((65280&a)>>>8),this.bufferBuilder.append(255&a)},e.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32)),c=a%Math.pow(2,32);this.bufferBuilder.append((4278190080&b)>>>24),this.bufferBuilder.append((16711680&b)>>>16),this.bufferBuilder.append((65280&b)>>>8),this.bufferBuilder.append(255&b),this.bufferBuilder.append((4278190080&c)>>>24),this.bufferBuilder.append((16711680&c)>>>16),this.bufferBuilder.append((65280&c)>>>8),this.bufferBuilder.append(255&c)}},{"./bufferbuilder":13}],13:[function(a,b,c){function d(){this._pieces=[],this._parts=[]}var e={};e.useBlobBuilder=function(){try{return new Blob([]),!1}catch(a){return!0}}(),e.useArrayBufferView=!e.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(a){return!0}}(),b.exports.binaryFeatures=e;var f=b.exports.BlobBuilder;"undefined"!=typeof window&&(f=b.exports.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder),d.prototype.append=function(a){"number"==typeof a?this._pieces.push(a):(this.flush(),this._parts.push(a))},d.prototype.flush=function(){if(this._pieces.length>0){var a=new Uint8Array(this._pieces);e.useArrayBufferView||(a=a.buffer),this._parts.push(a),this._pieces=[]}},d.prototype.getBuffer=function(){if(this.flush(),e.useBlobBuilder){for(var a=new f,b=0,c=this._parts.length;c>b;b++)a.append(this._parts[b]);return a.getBlob()}return new Blob(this._parts)},b.exports.BufferBuilder=d},{}],14:[function(a,b,c){function d(a,b){return this instanceof d?(this._dc=a,e.debug=b,this._outgoing={},this._incoming={},this._received={},this._window=1e3,this._mtu=500,this._interval=0,this._count=0,this._queue=[],void this._setupDC()):new d(a)}var e=a("./util");d.prototype.send=function(a){var b=e.pack(a);return b.size<this._mtu?void this._handleSend(["no",b]):(this._outgoing[this._count]={ack:0,chunks:this._chunk(b)},e.debug&&(this._outgoing[this._count].timer=new Date),this._sendWindowedChunks(this._count),void(this._count+=1))},d.prototype._setupInterval=function(){var a=this;this._timeout=setInterval(function(){var b=a._queue.shift();if(b._multiple)for(var c=0,d=b.length;d>c;c+=1)a._intervalSend(b[c]);else a._intervalSend(b)},this._interval)},d.prototype._intervalSend=function(a){var b=this;a=e.pack(a),e.blobToBinaryString(a,function(a){b._dc.send(a)}),0===b._queue.length&&(clearTimeout(b._timeout),b._timeout=null)},d.prototype._processAcks=function(){for(var a in this._outgoing)this._outgoing.hasOwnProperty(a)&&this._sendWindowedChunks(a)},d.prototype._handleSend=function(a){for(var b=!0,c=0,d=this._queue.length;d>c;c+=1){var e=this._queue[c];e===a?b=!1:e._multiple&&-1!==e.indexOf(a)&&(b=!1)}b&&(this._queue.push(a),this._timeout||this._setupInterval())},d.prototype._setupDC=function(){var a=this;this._dc.onmessage=function(b){var c=b.data,d=c.constructor;if(d===String){var f=e.binaryStringToArrayBuffer(c);c=e.unpack(f),a._handleMessage(c)}}},d.prototype._handleMessage=function(a){var b,c=a[1],d=this._incoming[c],f=this._outgoing[c];switch(a[0]){case"no":var g=c;g&&this.onmessage(e.unpack(g));break;case"end":if(b=d,this._received[c]=a[2],!b)break;this._ack(c);break;case"ack":if(b=f){var h=a[2];b.ack=Math.max(h,b.ack),b.ack>=b.chunks.length?(e.log("Time: ",new Date-b.timer),delete this._outgoing[c]):this._processAcks()}break;case"chunk":if(b=d,!b){var i=this._received[c];if(i===!0)break;b={ack:["ack",c,0],chunks:[]},this._incoming[c]=b}var j=a[2],k=a[3];b.chunks[j]=new Uint8Array(k),j===b.ack[2]&&this._calculateNextAck(c),this._ack(c);break;default:this._handleSend(a)}},d.prototype._chunk=function(a){for(var b=[],c=a.size,d=0;c>d;){var f=Math.min(c,d+this._mtu),g=a.slice(d,f),h={payload:g};b.push(h),d=f}return e.log("Created",b.length,"chunks."),b},d.prototype._ack=function(a){var b=this._incoming[a].ack;this._received[a]===b[2]&&(this._complete(a),this._received[a]=!0),this._handleSend(b)},d.prototype._calculateNextAck=function(a){for(var b=this._incoming[a],c=b.chunks,d=0,e=c.length;e>d;d+=1)if(void 0===c[d])return void(b.ack[2]=d);b.ack[2]=c.length},d.prototype._sendWindowedChunks=function(a){e.log("sendWindowedChunks for: ",a);for(var b=this._outgoing[a],c=b.chunks,d=[],f=Math.min(b.ack+this._window,c.length),g=b.ack;f>g;g+=1)c[g].sent&&g!==b.ack||(c[g].sent=!0,d.push(["chunk",a,g,c[g].payload]));b.ack+this._window>=c.length&&d.push(["end",a,c.length]),d._multiple=!0,this._handleSend(d)},d.prototype._complete=function(a){e.log("Completed called for",a);var b=this,c=this._incoming[a].chunks,d=new Blob(c);e.blobToArrayBuffer(d,function(a){b.onmessage(e.unpack(a))}),delete this._incoming[a]},d.higherBandwidthSDP=function(a){var b=navigator.appVersion.match(/Chrome\/(.*?) /);if(b&&(b=parseInt(b[1].split(".").shift()),31>b)){var c=a.split("b=AS:30"),d="b=AS:102400";if(c.length>1)return c[0]+d+c[1]}return a},d.prototype.onmessage=function(a){},b.exports.Reliable=d},{"./util":15}],15:[function(a,b,c){var d=a("js-binarypack"),e={debug:!1,inherits:function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},pack:d.pack,unpack:d.unpack,log:function(){if(e.debug){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a.unshift("Reliable: "),console.log.apply(console,a)}},setZeroTimeout:function(a){function b(b){d.push(b),a.postMessage(e,"*")}function c(b){b.source==a&&b.data==e&&(b.stopPropagation&&b.stopPropagation(),d.length&&d.shift()());
}var d=[],e="zero-timeout-message";return a.addEventListener?a.addEventListener("message",c,!0):a.attachEvent&&a.attachEvent("onmessage",c),b}(this),blobToArrayBuffer:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsArrayBuffer(a)},blobToBinaryString:function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsBinaryString(a)},binaryStringToArrayBuffer:function(a){for(var b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=255&a.charCodeAt(c);return b.buffer},randomToken:function(){return Math.random().toString(36).substr(2)}};b.exports=e},{"js-binarypack":12}]},{},[1]);